<!DOCTYPE html>
<html>
	<head>
		<script type="application/javascript" src="javascripts/jquery.js"></script>
		<script type="application/javascript" src="mustekala.js"></script>
		<script>
			$(function() {
				var mustekala=new Mustekala({
					debug: 1
					,authUrl: '/example/auth'
				});
				
				_debug('connecting...');
				mustekala.connect('/mustekala', function() {
					_debug('connected.');					
					// presence channel:
					var presenceChannel=mustekala.subscribe('presence@example-channel');
					presenceChannel.onSubscribe(function() {
						var members=presenceChannel.members;
						$.each(members, function(id, member) {
							$('#presence-members #user-'+id).css('color', '#0c0');
						});
						var user=presenceChannel.members.me;
						if(user) {
							$('#presence-members #user-name').html(' '+user.data.nickname+' ('+user.data.name+')');
						}
					});
					presenceChannel.onMemberJoin(function(user) {
						_debug('member joined. id:' + user.id);
						$('#presence-members #user-'+user.id).css('color', '#0c0');
					});
					presenceChannel.onMemberLeave(function(user) {
						_debug('member left. id:' + user.id);
						$('#presence-members #user-'+user.id).css('color', '#aaa');
					});
					
				});
				mustekala.onDisconnect(function() {
					_debug('disconnected from server.');
				});
				mustekala.onLog(function(data) {
					_debug('log: '+data);
				});
				mustekala.onSubscribe(function(channel) {
					_debug('subscribed to '+channel);
				});
				mustekala.onTrigger(function(channel,action,data) {
					_debug('channel "'+channel+'" triggered action: "'+action+'" with data: '+data);
				});

				$('#subscribe-button').click(function() {
					_debug('subscribing to '+$('#subscribe-channel').val()+'...');
					var channel=mustekala.subscribe($('#subscribe-channel').val());
					channel.on('show-alert', function(data) {
						alert('Hey! this is cool, isn\'t it?');
						if(data) {
							alert('Oh, and your data is: '+data);
						}
					});
				})

				$('#trigger-button').click(function() {
						if($('#trigger-post').is(':checked')) {
							$('#trigger-form').submit();
						} else {
							mustekala.trigger(
								$('#trigger-password').val(),
								$('#subscribe-channel').val(),
								$('#trigger-action').val(),
								$('#trigger-data').val()
							);
						}
				});
				
				function _debug(data) {
					$('.logger').val(function(i, val) {
						return data + "\n" + ( val ? val : '')
					});
				}
			});

		</script>
		<title>Mustekala :: Example</title>
	</head>
	<body>
		<form id="trigger-form" method="post" action="/mustekala/trigger">
			<div>
				<b>SUBSCRIBE</b>
				<br>
				channel: <input type="text" name="channel" id="subscribe-channel" value="example-channel">
				<input type="button" id="subscribe-button" value="subscribe">
			</div>
			<div>
				<b>TRIGGER</b>
				<br>
				action:<input type="text" name="action" id="trigger-action" value="show-alert">
				data: <input type="text" name="data" id="trigger-data" value="lorem ipsum">
				password:<input type="text" name="password" id="trigger-password" value="bGINGS/(ADNfg78GASIMDbkASbj">
				<input type="checkbox" id="trigger-post"> post?
				<input type="button" id="trigger-button" value="trigger">
			</div>
		</form>
		<div>
			<b>PRESENCE</b>
			<div id="presence-members">
				Hi<span id="user-name"></span>!<br>
				Channel users: [
				<span id="user-1000" style="color: #aaa;">joe</span>
				<span id="user-1001" style="color: #aaa;">deb</span>
				]
			</div>
		</div>
		<div>
			<b>LOGGER</b>
			<br>
			<textarea class="logger" rows="20" cols="100"></textarea>
		</div>
	</body>
</html>